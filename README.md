#MShell

Класс Mshell предназначен для кэширования результатов запросов к базам данных и HTML-разметки сгенерированных страниц. В качесве кэширующего сервера может использоваться Memcached или Redis. Для работы требуется класс \_PDO ([*https://github.com/avtomon/\_PDO*](https://github.com/avtomon/_PDO)), расширение PHP Memcache или Redis, а так же доступ к соответствующему серверу.

##Описание методов

####Класс class.mshell.php

#####create

    public static function create ($cache_type = MSHELL_CACHE_TYPE,
                                   $connect_type = MSHELL_CONNECT_TYPE,
                                   $hostorsock = MSHELL_SOCKET,
                                   $port = MSHELL_PORT,
                                   $ttl = MSHELL_TTL,
                                   $tag_ttl = MSHELL_TAG_TTL,
                                   $delay = MSHELL_DELAY,
                                   $solt = MSHELL_SOLT)

**Описание:**

Синглтон для получения объекта управления memcached.

**Параметры:**

-   Отличие в наличие класса clone, строго говоря, называться он может и по-другому, но его назначение крайне важно. Класс должен нести с собой стиль CSS делающий элемент с этим классом невидимым.$hostorsock* - имя, ip-адрес хоста или UNIX-сокет для подключения к Memcached;

-   *$dbdriver* - драйвер доступа к СУБД. На данный момент поддерживаются СУБД MySQL и PostgreSQL, допустимые значения: pgsql, mysql;

-   *$port* - порт, на котором Memcached слушает подключения (0 для Unix-сокета);

-   *$ttl* - время жизни элемента кэша;

-   *$tag_ttl* - время жизни тега сброса для кэша;

-   *$delay* - задержка между двумя последовательными запросами на получение блокировки на запись в кэш;

-   *$solt* - дополнительная соль для хэширования ключей кэша.

**Пример использования:**

    $mc = MShell::create();

<br>
#####getInstance

    public static function getInstance ()

**Описание:**

Получить уже созданный экземпляр класса.

**Параметры:** нет.

**Пример использования:**

    $current_cache = $c->getInstance

<br>
#####getKey

    private function getKey ($query)

**Описание:**

Функция получения ключа элемента кэша.

**Параметры:**

-   *$query* – текст запроса. В качестве ключа используется md5-хэш от конкатенации текста запроса и соли, заданной при создании объекта.

**Пример использования:**

    $key = $this->getKey($query . serialize($params));

<br>
#####beginTransaction

    public function beginTransaction ()

**Описание:**

Стартует транзакцию для исполнение в базе данных. Не выбрасывает исключение если транзакция стартуется повторно.

**Параметры:** нет.

**Пример использования:**

    $cache->beginTransaction();

<br>
#####commit

    public function commit ()

**Описание:**

Фиксирует транзакцию в базе данных. Не выбрасывает исключение если открытой транзакции нет.

**Параметры:** нет.

**Пример использования:**

    $cache->commit();

<br>
#####rollBack

    public function rollBack ()

**Описание:**

Откатывает транзакцию. Не выбрасывает исключение если нет открытой транзакции.

**Параметры:** нет.

**Пример использования:**

    $cache->rollBack();

<br>
#####getValue

    public function getValue ($query, array $params = array(), $expires = 120)

**Описание:**

Возвращает данные. Если надо лезет за ними в базу, иначе берет из кэша

**Параметры:**

-   *$query* - текст запроса;

-   *$params* - массив параметров запроса;

-   *$expires* - время, в течение которого элемент кэша считается актульным

**Пример использования:**

    $result = $cache->getValue($sql, $data, 0);

<br>
#####initTags

    private function initTags (array $tags = array())

**Описание:**

Инициализация заданного массива тегов.

**Параметры:**

-   *$tags* - заданный массив тегов.

**Пример использования:**

    $this->initTags($tags);

<br>
#####setValue

    private function setValue ($key, $value, $expires)

**Описание:**

Сохранение результата запроса в кэше.

**Параметры:**

-   *$key* - ключ сохраняемых данных;

-   *$value* - сохраняемые данные;

-   *$expires* - сколько считать данные актуальными.

**Пример использования:**

    $this->setValue($key, $value, $expires);

<br>
#####saveHTML

    public function saveHTML($html, $url, $expire)

**Описание:**

Сохраняет разметку страницы в кэше.

**Параметры:**

-   *$html* - html-разметка страницы;

-   *$url* - урл по которому хостится страница;

-   *$expires* - сколько считать данные актуальными.

**Пример использования:**

    $cache->saveHTML($html, $_REQUEST['page'], $source['expire']);

<br>
#####getHTML

    public function getHTML ($url)

**Описание:**

Достать разметку страницы из кэша.

**Параметры:**

-   *$url* - урл по которому хостится страница.

**Пример использования:**

    $html = $cache->getHTML($_REQUEST['page']);

<br>
#####delHTML

    public function delHTML ($url)

**Описание:**

Удаляет разметку определенной страницы из кэша.

**Параметры:**

-   *$url* - урл по которому хостится страница.

**Пример использования:**

    $cache->delHTML($page_url);

<br>
#####delHTMLs

    public function delHTML ($url)

**Описание:**

Удаляет разметку нескольких страниц из кэша.

**Параметры:**

-   *$urls* - адреса удаляемых страниц.

**Пример использования:**

    $cache->delHTMLs($urls);

<br>
***
##Механика работы

На вход модуля поступает запрос на выборку из базы данных или урл страницы, которую нужно достать из кэша.
Если это запрос на выборку из базы, то модуль ищет соответствующие данные в кэше, если такие данные присутствуют и они актуальны - возвращает их. Если же данные отсутствую или "протухли" системы пытается достать эти данные из базы попутно выставив блокировку на соответствующий ключ, чтобы не возникало состояния гонки в доступе к базе. Результат выборки сохраняется в кэше на время указанное в параметре expire и отдается клиенту. Модуль поддерживает систему тегов. В текущей редакции теги представляют собой список таблиц базы. Если происходит изменение в какой-либо из таблиц, то соответствующий этой таблице тег сбрасывается и все элементы кэша, связанные с этой таблицей, становятся неактуальными. Это сделано для исключения ситуации отдачи из кэша неактуальных данных.
Если же модуль попросили достать из кэша код страницы, то система смотрит есть ли актуальная копия разметки страницы и в противном случае просто возвращает false.
